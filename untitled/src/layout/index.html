<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link href="htmljs/bootstrap.min.css" rel="stylesheet">
    <script src="htmljs/jquery.min.js"></script>
    <script src="htmljs/bootstrap.min.js"></script>
    <style>
        body { padding-top: 10px; }
        .container { padding: 15px; }
        .form-group label { font-weight: bold; }
        .btn-group { width: 100%; display: flex; }
        .btn-group .btn { flex-grow: 1; margin: 0 5px; }
        .form-check-label { margin-right: 15px; }
    </style>
</head>

<body>
<div class="container">
    <div class="alert alert-info" role="alert">
        <strong>ğŸš› è®¢å•ç­›é€‰é…ç½®</strong>
    </div>

    <div class="form-group mb-3">
        <label for="minPrice" class="form-label">æœ€ä½é‡‘é¢ (å…ƒ)</label>
        <input type="number" class="form-control" id="minPrice" placeholder="0è¡¨ç¤ºä¸é™åˆ¶">
    </div>

    <div class="form-group mb-3">
        <label for="maxDistance" class="form-label">æœ€è¿œè·ç¦» (å…¬é‡Œ)</label>
        <input type="number" class="form-control" id="maxDistance" placeholder="0è¡¨ç¤ºä¸é™åˆ¶">
    </div>
    
    <div class="form-group mb-3">
        <label class="form-label">æ¥å—è½¦å‹</label>
        <div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="vehicle_any" value="ä¸é™">
                <label class="form-check-label" for="vehicle_any">ä¸é™</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="vehicle_xiangshi" value="å¢å¼">
                <label class="form-check-label" for="vehicle_xiangshi">å¢å¼</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="vehicle_pingban" value="å¹³æ¿">
                <label class="form-check-label" for="vehicle_pingban">å¹³æ¿</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="vehicle_gaolan" value="é«˜æ ">
                <label class="form-check-label" for="vehicle_gaolan">é«˜æ </label>
            </div>
        </div>
    </div>

    <div class="form-group mb-3">
        <label for="keywordBlacklist" class="form-label">å…³é”®è¯å±è”½ (é€—å·éš”å¼€)</label>
        <textarea class="form-control" id="keywordBlacklist" rows="3" placeholder="ä¾‹å¦‚ï¼šäººå·¥,å¸¦å°¾æ¿,å°ä»¶"></textarea>
    </div>

    <hr>
    
    <div class="btn-group mt-3">
        <button type="button" class="btn btn-primary" onclick="saveParam()">ğŸ’¾ ä¿å­˜é…ç½®</button>
        <button type="button" class="btn btn-success" onclick="start()">ğŸš€ æ‰§è¡Œè„šæœ¬</button>
    </div>
    <div class="btn-group mt-2">
        <button type="button" class="btn btn-warning" onclick="pause()">â¸ï¸ æš‚åœ</button>
        <button type="button" class="btn btn-info" onclick="continueRun()">â–¶ï¸ ç»§ç»­</button>
    </div>
</div>

<script>
    function pause() {
        // timeout: 0 è¡¨ç¤ºæ°¸ä¹…æš‚åœï¼Œç›´åˆ°æ‰‹åŠ¨æ¢å¤
        window.ec.setScriptPause({"pause": true, "timeout": 0});
    }

    function continueRun() {
        window.ec.setScriptPause({"pause": false, "timeout": 0});
    }
    
    function start() {
        // å…ˆä¿å­˜ä¸€æ¬¡ï¼Œç¡®ä¿è¿è¡Œçš„æ˜¯æœ€æ–°é…ç½®
        saveParam(true); 
    }

    function resetParam() {
        // ä»åå°è„šæœ¬çš„æ–‡ä»¶ä¸­è¯»å–é…ç½®
        window.ec.call("readConfigFromFile", null, function(resp) {
            if (!resp) return;

            let p = JSON.parse(resp);
            $("#minPrice").val(p.minPrice || '');
            $("#maxDistance").val(p.maxDistance || '');
            $("#keywordBlacklist").val(p.keywordBlacklist ? p.keywordBlacklist.join(',') : '');
            
            $('input[type="checkbox"]').prop('checked', false);
            if (p.vehicleTypes && p.vehicleTypes.length > 0) {
                p.vehicleTypes.forEach(function(vehicle) {
                    $(`input[type="checkbox"][value="${vehicle}"]`).prop('checked', true);
                });
            } else {
                 $('#vehicle_any').prop('checked', true);
            }
        });
    }

    function saveParam(isStarting) {
        let vehicleTypes = [];
        $('input[type="checkbox"]:checked').each(function() {
            vehicleTypes.push($(this).val());
        });

        if (vehicleTypes.includes('ä¸é™') || vehicleTypes.length === 0) {
            vehicleTypes = ['ä¸é™'];
        }

        let keywordBlacklist = $("#keywordBlacklist").val().split(/,|ï¼Œ/).map(k => k.trim()).filter(Boolean);

        let config = {
            minPrice: parseFloat($("#minPrice").val()) || 0,
            maxDistance: parseFloat($("#maxDistance").val()) || 0,
            vehicleTypes: vehicleTypes,
            keywordBlacklist: keywordBlacklist
        };
        
        let configJson = JSON.stringify(config);
        console.log("è°ƒç”¨åå°ä¿å­˜é…ç½®: " + configJson);

        // è°ƒç”¨åå°è„šæœ¬æ³¨å†Œçš„å‡½æ•°æ¥ä¿å­˜é…ç½®
        window.ec.call("saveConfigToFile", configJson, function (resp) {
            if (resp === "true") {
                if (isStarting === true) {
                     window.ec.start();
                } else {
                     alert("ä¿å­˜æˆåŠŸ!");
                }
            } else {
                alert("ä¿å­˜å¤±è´¥! åå°è„šæœ¬å¯èƒ½æœªè¿è¡Œæˆ–å‘ç”Ÿé”™è¯¯ã€‚");
            }
        });
    }

    $(document).ready(function () {
        resetParam();

        // "ä¸é™"ä¸å…¶ä»–é€‰é¡¹çš„äº’æ–¥é€»è¾‘
        $('#vehicle_any').on('change', function() {
            if ($(this).is(':checked')) {
                // å¦‚æœ"ä¸é™"è¢«é€‰ä¸­ï¼Œå–æ¶ˆå…¶ä»–æ‰€æœ‰è½¦å‹çš„é€‰ä¸­
                $('#vehicle_xiangshi, #vehicle_pingban, #vehicle_gaolan').prop('checked', false);
            }
        });

        $('#vehicle_xiangshi, #vehicle_pingban, #vehicle_gaolan').on('change', function() {
            if ($(this).is(':checked')) {
                // å¦‚æœå…¶ä»–ä»»ä¸€è½¦å‹è¢«é€‰ä¸­ï¼Œå–æ¶ˆ"ä¸é™"çš„é€‰ä¸­
                $('#vehicle_any').prop('checked', false);
            }
        });
    });
</script>
</body>
</html>