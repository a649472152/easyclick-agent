name: EasyClick Diagnostic & Fix Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout code with LFS
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: Git LFS pull
      run: git lfs pull

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest-stable'

    - name: Deep Source Verification
      run: |
        echo "ğŸ” æ·±åº¦éªŒè¯æºæ–‡ä»¶..."
        
        echo "=== é¡¹ç›®ç»“æ„æ£€æŸ¥ ==="
        find . -name "*.framework" -type d
        find . -name "*.xcodeproj" -type d
        find . -name "*.app" -type d || echo "æ„å»ºå‰æ— .appæ–‡ä»¶ï¼ˆæ­£å¸¸ï¼‰"
        
        echo "=== å…³é”®æ–‡ä»¶å¤§å°æ£€æŸ¥ ==="
        ls -la iosauto.framework/iosauto
        ls -la WebDriverAgentLib.framework/WebDriverAgentLib
        ls -la tj-easyclick-agent.xcodeproj/project.pbxproj
        
        echo "=== Info.plistæ£€æŸ¥ ==="
        if [ -f "iosauto.framework/Info.plist" ]; then
          echo "iosauto.framework Info.plist å†…å®¹:"
          cat iosauto.framework/Info.plist
        fi
        
        echo "=== éªŒè¯å…³é”®äºŒè¿›åˆ¶æ–‡ä»¶ ==="
        file iosauto.framework/iosauto
        file WebDriverAgentLib.framework/WebDriverAgentLib

    - name: Build with Maximum Diagnostics
      run: |
        echo "ğŸ”¨ å¼€å§‹è¯Šæ–­æ€§æ„å»º..."
        
        # è®¾ç½®è¯¦ç»†çš„æ„å»ºç¯å¢ƒ
        export XCODE_XCCONFIG_FILE=""
        export DEVELOPER_DIR="/Applications/Xcode.app/Contents/Developer"
        
        p=$(pwd)
        rm -rf /tmp/derivedDataPath/*
        
        echo "ğŸ› ï¸ Xcodebuild with full logging..."
        xcodebuild build-for-testing \
          -project tj-easyclick-agent.xcodeproj \
          -scheme WebDriverAgentRunner \
          -sdk iphoneos \
          -configuration Release \
          -derivedDataPath /tmp/derivedDataPath \
          -allowProvisioningUpdates \
          -verbose \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          | tee build.log
        
        echo "ğŸ“‚ æ„å»ºè¾“å‡ºå®Œæ•´æ£€æŸ¥..."
        cd /tmp/derivedDataPath/Build/Products/Release-iphoneos
        
        echo "=== æ‰€æœ‰æ–‡ä»¶åˆ—è¡¨ ==="
        ls -la
        
        echo "=== æŸ¥æ‰¾æ‰€æœ‰.appæ–‡ä»¶ ==="
        find . -name "*.app" -type d -exec ls -la {} \;
        
        # è®°å½•æ„å»ºå‰çš„çŠ¶æ€
        echo "=== æ„å»ºç›®å½•è¯¦ç»†ä¿¡æ¯ ==="
        for item in *; do
          if [ -d "$item" ]; then
            echo "ç›®å½•: $item"
            ls -la "$item" | head -10
            echo "---"
          else
            echo "æ–‡ä»¶: $item ($(du -h "$item" | cut -f1))"
          fi
        done

    - name: Manual IPA Creation with Full Validation
      run: |
        cd /tmp/derivedDataPath/Build/Products/Release-iphoneos
        
        echo "ğŸ”§ æ‰‹åŠ¨åˆ›å»ºIPAæ–‡ä»¶..."
        
        # 1. æ¸…ç†ä¸éœ€è¦çš„æ–‡ä»¶
        echo "Step 1: æ¸…ç†ä¸éœ€è¦çš„æ–‡ä»¶"
        rm -rf IntegrationApp.app || true
        ls -la
        
        # 2. éªŒè¯ç›®æ ‡appæ–‡ä»¶
        echo "Step 2: éªŒè¯ç›®æ ‡appæ–‡ä»¶"
        TARGET_APP=""
        for app in *.app; do
          if [ -d "$app" ] && [[ "$app" != "IntegrationApp.app" ]]; then
            TARGET_APP="$app"
            break
          fi
        done
        
        if [ -z "$TARGET_APP" ]; then
          echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æœ‰æ•ˆçš„.appæ–‡ä»¶"
          echo "å¯ç”¨æ–‡ä»¶:"
          ls -la
          exit 1
        fi
        
        echo "âœ… æ‰¾åˆ°ç›®æ ‡app: $TARGET_APP"
        
        # 3. æ·±åº¦æ£€æŸ¥appå†…å®¹
        echo "Step 3: æ·±åº¦æ£€æŸ¥appå†…å®¹"
        echo "Appç›®å½•å†…å®¹:"
        ls -la "$TARGET_APP"
        
        echo "Appå¯æ‰§è¡Œæ–‡ä»¶:"
        find "$TARGET_APP" -type f -perm +111 | head -5
        
        echo "App Info.plist:"
        if [ -f "$TARGET_APP/Info.plist" ]; then
          plutil -p "$TARGET_APP/Info.plist" | head -20
        else
          echo "âŒ ç¼ºå°‘Info.plistæ–‡ä»¶!"
        fi
        
        # 4. åˆ›å»ºæ ‡å‡†Payloadç»“æ„
        echo "Step 4: åˆ›å»ºæ ‡å‡†Payloadç»“æ„"
        rm -rf Payload
        mkdir -p Payload
        
        # å¤åˆ¶è€Œä¸æ˜¯ç§»åŠ¨ï¼Œé¿å…æƒé™é—®é¢˜
        cp -R "$TARGET_APP" Payload/
        
        echo "éªŒè¯Payloadç»“æ„:"
        ls -la Payload/
        
        # 5. éªŒè¯appåœ¨Payloadä¸­çš„å®Œæ•´æ€§
        echo "Step 5: éªŒè¯Payloadä¸­çš„app"
        PAYLOAD_APP="Payload/$TARGET_APP"
        if [ -d "$PAYLOAD_APP" ]; then
          echo "âœ… Appå·²æ­£ç¡®æ”¾å…¥Payload"
          ls -la "$PAYLOAD_APP"
          
          if [ -f "$PAYLOAD_APP/Info.plist" ]; then
            echo "âœ… Info.plistå­˜åœ¨"
          else
            echo "âŒ Info.plistç¼ºå¤±"
          fi
          
          # æ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶
          APP_EXECUTABLE=$(find "$PAYLOAD_APP" -type f -perm +111 | grep -v Framework | head -1)
          if [ -n "$APP_EXECUTABLE" ]; then
            echo "âœ… å¯æ‰§è¡Œæ–‡ä»¶: $APP_EXECUTABLE"
            ls -la "$APP_EXECUTABLE"
          else
            echo "âŒ æœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
          fi
        else
          echo "âŒ Appæœªæ­£ç¡®å¤åˆ¶åˆ°Payload"
          exit 1
        fi
        
        # 6. åˆ›å»ºIPA
        echo "Step 6: åˆ›å»ºIPAæ–‡ä»¶"
        zip -r tj-easyclick-agent-diagnostic.ipa Payload
        
        echo "âœ… IPAåˆ›å»ºå®Œæˆ:"
        ls -la tj-easyclick-agent-diagnostic.ipa
        
        # 7. éªŒè¯IPAå†…å®¹
        echo "Step 7: éªŒè¯IPAå†…éƒ¨ç»“æ„"
        echo "IPAå†…å®¹åˆ—è¡¨:"
        unzip -l tj-easyclick-agent-diagnostic.ipa
        
        echo "éªŒè¯å…³é”®è·¯å¾„:"
        unzip -l tj-easyclick-agent-diagnostic.ipa | grep -E "(Payload/.*\.app/|Info\.plist|executable)"
        
        # 8. åˆ›å»ºæµ‹è¯•è§£å‹
        echo "Step 8: æµ‹è¯•è§£å‹éªŒè¯"
        mkdir -p test-extract
        cd test-extract
        unzip -q ../tj-easyclick-agent-diagnostic.ipa
        
        if [ -d "Payload" ]; then
          echo "âœ… Payloadç›®å½•å­˜åœ¨"
          EXTRACTED_APP=$(find Payload -name "*.app" -type d | head -1)
          if [ -n "$EXTRACTED_APP" ]; then
            echo "âœ… æå–çš„app: $EXTRACTED_APP"
            ls -la "$EXTRACTED_APP"
          else
            echo "âŒ æå–åæœªæ‰¾åˆ°.appæ–‡ä»¶"
          fi
        else
          echo "âŒ æå–åæ— Payloadç›®å½•"
        fi
        
        cd ..
        
        # å¤åˆ¶åˆ°æ ¹ç›®å½•
        cp tj-easyclick-agent-diagnostic.ipa /tmp/final-ipa.ipa

    - name: Create TrollStore Version (Minimal Changes)
      run: |
        cd /tmp/derivedDataPath/Build/Products/Release-iphoneos
        
        echo "ğŸª åˆ›å»ºTrollStoreç‰ˆæœ¬ï¼ˆæœ€å°ä¿®æ”¹ï¼‰..."
        
        if [ -f "tj-easyclick-agent-diagnostic.ipa" ]; then
          mkdir -p trollstore-work
          cd trollstore-work
          
          # è§£å‹åŸå§‹IPA
          unzip -q ../tj-easyclick-agent-diagnostic.ipa
          
          if [ -d "Payload" ]; then
            APP_DIR=$(find Payload -name "*.app" -type d | head -1)
            
            if [ -n "$APP_DIR" ]; then
              echo "å¤„ç†TrollStoreç‰ˆæœ¬: $APP_DIR"
              
              # åªç§»é™¤ç­¾åæ–‡ä»¶ï¼Œä¸æ·»åŠ ä»»ä½•æ–°æ–‡ä»¶
              rm -rf "$APP_DIR/_CodeSignature" 2>/dev/null || true
              rm -f "$APP_DIR/embedded.mobileprovision" 2>/dev/null || true
              
              echo "TrollStoreç‰ˆæœ¬æ–‡ä»¶æ¸…ç†å®Œæˆ"
              ls -la "$APP_DIR"
              
              # é‡æ–°æ‰“åŒ…
              zip -r ../tj-easyclick-agent-trollstore.ipa Payload
              
              echo "âœ… TrollStoreç‰ˆæœ¬åˆ›å»ºå®Œæˆ"
            else
              echo "âŒ TrollStoreç‰ˆæœ¬: æœªæ‰¾åˆ°appæ–‡ä»¶"
            fi
          else
            echo "âŒ TrollStoreç‰ˆæœ¬: æ— Payloadç›®å½•"
          fi
          
          cd ..
        else
          echo "âŒ åŸå§‹IPAä¸å­˜åœ¨ï¼Œè·³è¿‡TrollStoreç‰ˆæœ¬"
        fi

    - name: Final Comprehensive Report
      run: |
        echo "ğŸ“Š æœ€ç»ˆè¯Šæ–­æŠ¥å‘Š"
        echo "===================="
        
        cd /tmp/derivedDataPath/Build/Products/Release-iphoneos
        
        echo "ç”Ÿæˆçš„æ–‡ä»¶:"
        ls -la *.ipa 2>/dev/null || echo "æ— IPAæ–‡ä»¶ç”Ÿæˆ"
        
        for ipa in *.ipa; do
          if [ -f "$ipa" ]; then
            echo ""
            echo "=== $ipa è¯¦ç»†ä¿¡æ¯ ==="
            echo "æ–‡ä»¶å¤§å°: $(du -h "$ipa" | cut -f1)"
            echo "æ–‡ä»¶ç±»å‹: $(file "$ipa")"
            echo ""
            echo "å†…å®¹ç»“æ„:"
            unzip -l "$ipa" | head -30
            echo ""
            echo "å…³é”®è·¯å¾„éªŒè¯:"
            unzip -l "$ipa" | grep -E "(Payload/.*\.app/|Info\.plist)" | head -10
            echo "-------------------"
          fi
        done
        
        echo ""
        echo "ğŸ’¡ è¯Šæ–­å»ºè®®:"
        echo "1. æ£€æŸ¥ä¸Šè¿°IPAç»“æ„æ˜¯å¦åŒ…å« Payload/XXX.app/ è·¯å¾„"
        echo "2. ç¡®è®¤.appç›®å½•å†…æœ‰Info.plistæ–‡ä»¶"
        echo "3. éªŒè¯å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦å­˜åœ¨"
        echo "4. å¦‚æœç»“æ„æ­£ç¡®ä½†ä»å¤±è´¥ï¼Œé—®é¢˜å¯èƒ½åœ¨äºInfo.plistå†…å®¹"

    - name: Upload Diagnostic IPA
      uses: actions/upload-artifact@v4
      with:
        name: EasyClick-Diagnostic-IPA
        path: /tmp/derivedDataPath/Build/Products/Release-iphoneos/tj-easyclick-agent-diagnostic.ipa
        retention-days: 30

    - name: Upload TrollStore IPA
      uses: actions/upload-artifact@v4
      with:
        name: EasyClick-TrollStore-Diagnostic
        path: /tmp/derivedDataPath/Build/Products/Release-iphoneos/tj-easyclick-agent-trollstore.ipa
        retention-days: 30
      continue-on-error: true

    - name: Upload Build Log
      uses: actions/upload-artifact@v4
      with:
        name: Build-Diagnostic-Log
        path: /tmp/derivedDataPath/Build/Products/Release-iphoneos/build.log
        retention-days: 7
      continue-on-error: true 