name: EasyClick for TrollStore (Ultra-Clean)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout code with LFS
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: Git LFS pull
      run: git lfs pull

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest-stable'

    - name: Build EasyClick Agent
      run: |
        echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘..."
        xcodebuild build-for-testing \
          -project tj-easyclick-agent.xcodeproj \
          -scheme WebDriverAgentRunner \
          -sdk iphoneos \
          -configuration Release \
          -derivedDataPath /tmp/derivedDataPath \
          -allowProvisioningUpdates \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    - name: Create TrollStore Ultra-Clean Version
      run: |
        cd /tmp/derivedDataPath/Build/Products/Release-iphoneos
        
        echo "ğŸ§¹ å½»åº•æ¸…ç†å’Œå‡†å¤‡TrollStoreç‰ˆæœ¬..."
        
        # ç§»é™¤ä¸éœ€è¦çš„app
        rm -rf IntegrationApp.app || true
        
        # æ‰¾åˆ°ç›®æ ‡app
        TARGET_APP=$(find . -maxdepth 1 -name "*.app" -type d | head -1)
        
        if [ -z "$TARGET_APP" ]; then
          echo "âŒ æœªæ‰¾åˆ°appæ–‡ä»¶"
          exit 1
        fi
        
        echo "âœ… å¤„ç†app: $TARGET_APP"
        
        # åˆ›å»ºå¹²å‡€çš„å·¥ä½œç›®å½•
        rm -rf TrollStore-Clean
        mkdir -p TrollStore-Clean/Payload
        
        # å¤åˆ¶appåˆ°æ–°ç›®å½•
        cp -r "$TARGET_APP" TrollStore-Clean/Payload/
        
        APP_PATH="TrollStore-Clean/Payload/$(basename "$TARGET_APP")"
        echo "ğŸ¯ æ¸…ç†appè·¯å¾„: $APP_PATH"
        
        # 1. ç§»é™¤æ‰€æœ‰ç­¾åç›¸å…³æ–‡ä»¶
        echo "ğŸ—‘ï¸ ç§»é™¤ç­¾åæ–‡ä»¶..."
        rm -rf "$APP_PATH/_CodeSignature" 2>/dev/null || true
        rm -f "$APP_PATH/embedded.mobileprovision" 2>/dev/null || true
        rm -f "$APP_PATH"/*.mobileprovision 2>/dev/null || true
        
        # 2. ç§»é™¤Frameworksä¸­çš„æ‰€æœ‰ç­¾å
        if [ -d "$APP_PATH/Frameworks" ]; then
          echo "ğŸ—‘ï¸ æ¸…ç†Frameworksç­¾å..."
          find "$APP_PATH/Frameworks" -name "_CodeSignature" -type d -exec rm -rf {} + 2>/dev/null || true
          find "$APP_PATH/Frameworks" -name "*.mobileprovision" -delete 2>/dev/null || true
        fi
        
        # 3. ç§»é™¤PlugInsä¸­çš„æ‰€æœ‰ç­¾å
        if [ -d "$APP_PATH/PlugIns" ]; then
          echo "ğŸ—‘ï¸ æ¸…ç†PlugInsç­¾å..."
          find "$APP_PATH/PlugIns" -name "_CodeSignature" -type d -exec rm -rf {} + 2>/dev/null || true
          find "$APP_PATH/PlugIns" -name "*.mobileprovision" -delete 2>/dev/null || true
        fi
        
        # 4. ç§»é™¤ä»»ä½•å¯èƒ½çš„ç­¾åæ®‹ç•™
        find "$APP_PATH" -name "_CodeSignature" -type d -exec rm -rf {} + 2>/dev/null || true
        find "$APP_PATH" -name "*.mobileprovision" -type f -delete 2>/dev/null || true
        find "$APP_PATH" -name "CodeResources" -type f -delete 2>/dev/null || true
        
        # 5. åˆ›å»ºæœ€å°åŒ–çš„Info.plistï¼ˆç§»é™¤å¯èƒ½çš„ç­¾åç›¸å…³é”®ï¼‰
        if [ -f "$APP_PATH/Info.plist" ]; then
          echo "ğŸ“ ä¼˜åŒ–Info.plist..."
          # å¤‡ä»½åŸå§‹æ–‡ä»¶
          cp "$APP_PATH/Info.plist" "$APP_PATH/Info.plist.backup"
          
          # ä½¿ç”¨plutilç§»é™¤ç­¾åç›¸å…³çš„é”®
          /usr/libexec/PlistBuddy -c "Delete :ApplicationIdentifierPrefix" "$APP_PATH/Info.plist" 2>/dev/null || true
          /usr/libexec/PlistBuddy -c "Delete :SignerIdentity" "$APP_PATH/Info.plist" 2>/dev/null || true
          /usr/libexec/PlistBuddy -c "Delete :TeamIdentifier" "$APP_PATH/Info.plist" 2>/dev/null || true
        fi
        
        # 6. åˆ›å»ºç®€åŒ–çš„entitlements.plistï¼ˆTrollStoreä¸“ç”¨ï¼‰
        echo "ğŸ“„ åˆ›å»ºTrollStoreä¸“ç”¨entitlements..."
        cat > "$APP_PATH/entitlements.plist" << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
          <key>get-task-allow</key>
          <true/>
          <key>com.apple.private.dtrace.allow</key>
          <true/>
        </dict>
        </plist>
        EOF
        
        # 7. éªŒè¯æ¸…ç†ç»“æœ
        echo "ğŸ” éªŒè¯æ¸…ç†ç»“æœ..."
        echo "å‰©ä½™çš„ç­¾åç›¸å…³æ–‡ä»¶:"
        find "$APP_PATH" -name "*CodeSignature*" -o -name "*.mobileprovision" -o -name "*signature*" 2>/dev/null || echo "âœ… æ— ç­¾åæ–‡ä»¶æ®‹ç•™"
        
        # 8. æ‰“åŒ…ä¸ºIPA
        cd TrollStore-Clean
        echo "ğŸ“¦ æ‰“åŒ…TrollStoreä¸“ç”¨IPA..."
        zip -r ../EasyClick-TrollStore-UltraClean.ipa Payload
        
        cd ..
        echo "âœ… TrollStoreä¸“ç”¨IPAåˆ›å»ºå®Œæˆ:"
        ls -la EasyClick-TrollStore-UltraClean.ipa

    - name: Create Alternative Version (Minimal)
      run: |
        cd /tmp/derivedDataPath/Build/Products/Release-iphoneos
        
        echo "ğŸ¯ åˆ›å»ºæœ€å°åŒ–ç‰ˆæœ¬..."
        
        # ä½¿ç”¨ç°æœ‰çš„cleanç‰ˆæœ¬
        if [ -d "TrollStore-Clean" ]; then
          rm -rf Minimal-Version
          cp -r TrollStore-Clean Minimal-Version
          
          APP_PATH=$(find Minimal-Version/Payload -name "*.app" -type d | head -1)
          
          if [ -n "$APP_PATH" ]; then
            echo "ğŸ—‘ï¸ è¿›ä¸€æ­¥ç²¾ç®€..."
            
            # ç§»é™¤ä¸å¿…è¦çš„frameworksï¼ˆä¿ç•™æ ¸å¿ƒçš„ï¼‰
            if [ -d "$APP_PATH/Frameworks" ]; then
              echo "ğŸ“¦ ç²¾ç®€Frameworks..."
              # åªä¿ç•™å…³é”®çš„æ¡†æ¶
              cd "$APP_PATH/Frameworks"
              for fw in *.dylib *.framework; do
                if [[ "$fw" == *"WebDriverAgent"* ]] || [[ "$fw" == *"iosauto"* ]]; then
                  echo "ä¿ç•™: $fw"
                else
                  echo "ç§»é™¤: $fw"
                  rm -rf "$fw" 2>/dev/null || true
                fi
              done
              cd - > /dev/null
            fi
            
            # ç§»é™¤å¯èƒ½çš„è°ƒè¯•ä¿¡æ¯
            find "$APP_PATH" -name "*.dSYM" -exec rm -rf {} + 2>/dev/null || true
            find "$APP_PATH" -name "*.symbols" -exec rm -rf {} + 2>/dev/null || true
            
            cd Minimal-Version
            zip -r ../EasyClick-TrollStore-Minimal.ipa Payload
            cd ..
            
            echo "âœ… æœ€å°åŒ–ç‰ˆæœ¬åˆ›å»ºå®Œæˆ:"
            ls -la EasyClick-TrollStore-Minimal.ipa
          fi
        fi

    - name: Create Standard Clean Version
      run: |
        cd /tmp/derivedDataPath/Build/Products/Release-iphoneos
        
        echo "ğŸ“± åˆ›å»ºæ ‡å‡†æ¸…ç†ç‰ˆæœ¬..."
        
        rm -rf Standard-Clean
        mkdir -p Standard-Clean/Payload
        
        TARGET_APP=$(find . -maxdepth 1 -name "*.app" -type d | grep -v IntegrationApp | head -1)
        cp -r "$TARGET_APP" Standard-Clean/Payload/
        
        cd Standard-Clean
        zip -r ../EasyClick-Standard-Clean.ipa Payload
        cd ..
        
        echo "âœ… æ ‡å‡†æ¸…ç†ç‰ˆæœ¬åˆ›å»ºå®Œæˆ:"
        ls -la EasyClick-Standard-Clean.ipa

    - name: Final Summary
      run: |
        cd /tmp/derivedDataPath/Build/Products/Release-iphoneos
        
        echo "ğŸ‰ æ„å»ºå®Œæˆï¼ç”Ÿæˆçš„IPAæ–‡ä»¶ï¼š"
        echo ""
        for ipa in *.ipa; do
          if [ -f "$ipa" ]; then
            size=$(du -h "$ipa" | cut -f1)
            echo "ğŸ“± $ipa - $size"
            
            # æ˜¾ç¤ºæ¯ä¸ªIPAçš„å†…å®¹æ¦‚è§ˆ
            echo "   å†…å®¹é¢„è§ˆ:"
            unzip -l "$ipa" | grep -E "(Payload/.*\.app/|\.dylib|\.framework)" | head -5
            echo ""
          fi
        done
        
        echo "ğŸ’¡ å®‰è£…å»ºè®®ï¼š"
        echo "1. ä¼˜å…ˆå°è¯•: EasyClick-TrollStore-UltraClean.ipa â†’ TrollStore"
        echo "2. å¤‡é€‰æ–¹æ¡ˆ: EasyClick-TrollStore-Minimal.ipa â†’ TrollStore"
        echo "3. ä¼ ç»Ÿæ–¹å¼: EasyClick-Standard-Clean.ipa â†’ Sideloadly/AltStore"

    - name: Upload TrollStore Ultra-Clean
      uses: actions/upload-artifact@v4
      with:
        name: EasyClick-TrollStore-UltraClean
        path: /tmp/derivedDataPath/Build/Products/Release-iphoneos/EasyClick-TrollStore-UltraClean.ipa
        retention-days: 30

    - name: Upload TrollStore Minimal
      uses: actions/upload-artifact@v4
      with:
        name: EasyClick-TrollStore-Minimal
        path: /tmp/derivedDataPath/Build/Products/Release-iphoneos/EasyClick-TrollStore-Minimal.ipa
        retention-days: 30
      continue-on-error: true

    - name: Upload Standard Clean
      uses: actions/upload-artifact@v4
      with:
        name: EasyClick-Standard-Clean
        path: /tmp/derivedDataPath/Build/Products/Release-iphoneos/EasyClick-Standard-Clean.ipa
        retention-days: 30 