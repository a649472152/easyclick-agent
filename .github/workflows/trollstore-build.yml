name: EasyClick Build for TrollStore (Fixed)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout code with LFS
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: Git LFS pull
      run: git lfs pull

    - name: Verify LFS files
      run: |
        echo "æ£€æŸ¥frameworkæ–‡ä»¶..."
        ls -la *.framework/ || echo "Frameworkç›®å½•æ£€æŸ¥å®Œæ¯•"
        echo "æ£€æŸ¥LFSè·Ÿè¸ªçš„æ–‡ä»¶..."
        git lfs ls-files

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest-stable'

    - name: Build EasyClick Agent
      run: |
        echo "å¼€å§‹ç¼–è¯‘..."
        xcodebuild build-for-testing \
          -project tj-easyclick-agent.xcodeproj \
          -scheme WebDriverAgentRunner \
          -sdk iphoneos \
          -configuration Release \
          -derivedDataPath /tmp/derivedDataPath \
          -allowProvisioningUpdates \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    - name: Create Standard IPA
      run: |
        cd /tmp/derivedDataPath/Build/Products/Release-iphoneos
        echo "æ¸…ç†ä¸éœ€è¦çš„app..."
        rm -rf IntegrationApp.app || true
        echo "åˆ›å»ºPayloadç›®å½•..."
        mkdir -p Payload
        echo "ç§»åŠ¨appåˆ°Payload..."
        mv *.app Payload/ || true
        echo "æ‰“åŒ…æ ‡å‡†ç‰ˆIPA..."
        zip -r EasyClick-Agent-Standard.ipa Payload
        echo "æ ‡å‡†ç‰ˆIPAæ–‡ä»¶ä¿¡æ¯:"
        ls -la EasyClick-Agent-Standard.ipa

    - name: Create TrollStore Compatible IPA
      run: |
        cd /tmp/derivedDataPath/Build/Products/Release-iphoneos
        
        # è§£å‹æ ‡å‡†IPAä»¥è¿›è¡Œå¤„ç†
        echo "è§£å‹æ ‡å‡†IPAè¿›è¡ŒTrollStoreå¤„ç†..."
        unzip -q EasyClick-Agent-Standard.ipa
        
        APP_PATH=$(find Payload -name "*.app" -type d | head -1)
        echo "å‘ç°appè·¯å¾„: $APP_PATH"
        
        if [ -n "$APP_PATH" ]; then
          echo "ä¸ºTrollStoreåˆ›å»ºentitlementsæ–‡ä»¶..."
          cat > entitlements.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
          <key>get-task-allow</key>
          <true/>
          <key>com.apple.private.dtrace.allow</key>
          <true/>
          <key>com.apple.private.security.no-container</key>
          <true/>
          <key>com.apple.private.skip-library-validation</key>
          <true/>
        </dict>
        </plist>
        EOF
          
          echo "ç§»é™¤ç°æœ‰ç­¾åæ–‡ä»¶..."
          rm -rf "$APP_PATH/_CodeSignature" || true
          rm -f "$APP_PATH/embedded.mobileprovision" || true
          find "$APP_PATH" -name "*.mobileprovision" -delete || true
          
          echo "é‡æ–°æ‰“åŒ…ä¸ºTrollStoreå…¼å®¹ç‰ˆæœ¬..."
          zip -r EasyClick-Agent-TrollStore.ipa Payload
          echo "TrollStoreç‰ˆæœ¬IPAæ–‡ä»¶ä¿¡æ¯:"
          ls -la EasyClick-Agent-TrollStore.ipa
        else
          echo "é”™è¯¯: æœªæ‰¾åˆ°appæ–‡ä»¶"
          exit 1
        fi

    - name: Create Fully Unsigned Version
      run: |
        cd /tmp/derivedDataPath/Build/Products/Release-iphoneos
        
        echo "åˆ›å»ºå®Œå…¨æ— ç­¾åç‰ˆæœ¬..."
        rm -rf Payload-Unsigned
        cp -r Payload Payload-Unsigned
        
        APP_PATH=$(find Payload-Unsigned -name "*.app" -type d | head -1)
        
        if [ -n "$APP_PATH" ]; then
          echo "ç§»é™¤æ‰€æœ‰ç­¾åç›¸å…³æ–‡ä»¶..."
          rm -rf "$APP_PATH/_CodeSignature" || true
          rm -rf "$APP_PATH/Frameworks/"*"/_CodeSignature" || true
          rm -f "$APP_PATH/embedded.mobileprovision" || true
          find "$APP_PATH" -name "*.mobileprovision" -delete || true
          find "$APP_PATH" -name "_CodeSignature" -type d -exec rm -rf {} + || true
          
          echo "æ‰“åŒ…å®Œå…¨æ— ç­¾åç‰ˆæœ¬..."
          zip -r EasyClick-Agent-Unsigned.ipa Payload-Unsigned
          echo "æ— ç­¾åç‰ˆæœ¬IPAæ–‡ä»¶ä¿¡æ¯:"
          ls -la EasyClick-Agent-Unsigned.ipa
        else
          echo "é”™è¯¯: æœªæ‰¾åˆ°appæ–‡ä»¶è¿›è¡Œæ— ç­¾åå¤„ç†"
          exit 1
        fi

    - name: Upload Standard IPA
      uses: actions/upload-artifact@v4
      with:
        name: EasyClick-Agent-Standard
        path: /tmp/derivedDataPath/Build/Products/Release-iphoneos/EasyClick-Agent-Standard.ipa
        retention-days: 30

    - name: Upload TrollStore IPA
      uses: actions/upload-artifact@v4
      with:
        name: EasyClick-Agent-TrollStore
        path: /tmp/derivedDataPath/Build/Products/Release-iphoneos/EasyClick-Agent-TrollStore.ipa
        retention-days: 30

    - name: Upload Unsigned IPA
      uses: actions/upload-artifact@v4
      with:
        name: EasyClick-Agent-Unsigned
        path: /tmp/derivedDataPath/Build/Products/Release-iphoneos/EasyClick-Agent-Unsigned.ipa
        retention-days: 30

    - name: Build Summary
      run: |
        cd /tmp/derivedDataPath/Build/Products/Release-iphoneos
        echo "ğŸ‰ æ„å»ºå®Œæˆï¼ç”Ÿæˆäº†3ä¸ªç‰ˆæœ¬çš„IPAæ–‡ä»¶ï¼š"
        echo "ğŸ“± æ ‡å‡†ç‰ˆ: EasyClick-Agent-Standard.ipa"
        echo "ğŸª TrollStoreç‰ˆ: EasyClick-Agent-TrollStore.ipa"
        echo "ğŸ”“ æ— ç­¾åç‰ˆ: EasyClick-Agent-Unsigned.ipa"
        echo ""
        echo "æ–‡ä»¶å¤§å°ä¿¡æ¯:"
        ls -lah *.ipa 