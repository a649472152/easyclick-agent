name: EasyClick Build for TrollStore (Fixed Structure)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout code with LFS
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: Git LFS pull
      run: git lfs pull

    - name: Verify LFS files
      run: |
        echo "æ£€æŸ¥frameworkæ–‡ä»¶..."
        ls -la *.framework/ || echo "Frameworkç›®å½•æ£€æŸ¥å®Œæ¯•"
        echo "æ£€æŸ¥LFSè·Ÿè¸ªçš„æ–‡ä»¶..."
        git lfs ls-files

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest-stable'

    - name: Build EasyClick Agent
      run: |
        echo "å¼€å§‹ç¼–è¯‘..."
        xcodebuild build-for-testing \
          -project tj-easyclick-agent.xcodeproj \
          -scheme WebDriverAgentRunner \
          -sdk iphoneos \
          -configuration Release \
          -derivedDataPath /tmp/derivedDataPath \
          -allowProvisioningUpdates \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    - name: Verify Build Output
      run: |
        cd /tmp/derivedDataPath/Build/Products/Release-iphoneos
        echo "ğŸ” æ£€æŸ¥ç¼–è¯‘è¾“å‡ºç›®å½•å†…å®¹:"
        ls -la
        echo ""
        echo "ğŸ” æŸ¥æ‰¾æ‰€æœ‰.appæ–‡ä»¶:"
        find . -name "*.app" -type d
        echo ""
        echo "ğŸ” æ£€æŸ¥æ¯ä¸ª.appæ–‡ä»¶çš„å†…å®¹:"
        for app in *.app; do
          if [ -d "$app" ]; then
            echo "ğŸ“± $app æ–‡ä»¶å¤¹å†…å®¹:"
            ls -la "$app"
            echo "---"
          fi
        done

    - name: Create Standard IPA (Fixed Structure)
      run: |
        cd /tmp/derivedDataPath/Build/Products/Release-iphoneos
        
        echo "ğŸ§¹ æ¸…ç†ä¸éœ€è¦çš„app..."
        rm -rf IntegrationApp.app || true
        
        echo "ğŸ“‚ åˆ›å»ºPayloadç›®å½•..."
        rm -rf Payload
        mkdir -p Payload
        
        echo "ğŸ” æŸ¥æ‰¾ç›®æ ‡appæ–‡ä»¶..."
        TARGET_APP=$(find . -maxdepth 1 -name "*.app" -type d | grep -v IntegrationApp | head -1)
        
        if [ -n "$TARGET_APP" ] && [ -d "$TARGET_APP" ]; then
          echo "âœ… æ‰¾åˆ°ç›®æ ‡app: $TARGET_APP"
          echo "ğŸ“± å¤åˆ¶appåˆ°Payloadç›®å½•..."
          cp -r "$TARGET_APP" Payload/
          
          echo "ğŸ” éªŒè¯Payloadç›®å½•ç»“æ„:"
          ls -la Payload/
          echo ""
          echo "ğŸ” éªŒè¯appå†…å®¹:"
          ls -la "Payload/$(basename "$TARGET_APP")"
          
          echo "ğŸ“¦ æ‰“åŒ…æ ‡å‡†ç‰ˆIPA..."
          zip -r EasyClick-Agent-Standard.ipa Payload
          
          echo "âœ… æ ‡å‡†ç‰ˆIPAæ–‡ä»¶ä¿¡æ¯:"
          ls -la EasyClick-Agent-Standard.ipa
          
          echo "ğŸ” éªŒè¯IPAå†…å®¹ç»“æ„:"
          unzip -l EasyClick-Agent-Standard.ipa | head -20
        else
          echo "âŒ æœªæ‰¾åˆ°æœ‰æ•ˆçš„.appæ–‡ä»¶"
          exit 1
        fi

    - name: Create TrollStore Version (Fixed Structure)
      run: |
        cd /tmp/derivedDataPath/Build/Products/Release-iphoneos
        
        echo "ğŸª åˆ›å»ºTrollStoreç‰ˆæœ¬..."
        rm -rf Payload-TrollStore
        cp -r Payload Payload-TrollStore
        
        APP_DIR=$(find Payload-TrollStore -name "*.app" -type d | head -1)
        
        if [ -n "$APP_DIR" ] && [ -d "$APP_DIR" ]; then
          echo "âœ… å¤„ç†TrollStoreç‰ˆæœ¬: $APP_DIR"
          
          echo "ğŸ—‘ï¸ ç§»é™¤ç­¾åæ–‡ä»¶..."
          rm -rf "$APP_DIR/_CodeSignature" || true
          rm -f "$APP_DIR/embedded.mobileprovision" || true
          find "$APP_DIR" -name "*.mobileprovision" -delete 2>/dev/null || true
          
          echo "ğŸ“„ åˆ›å»ºTrollStore entitlementsæ–‡ä»¶..."
          cat > "$APP_DIR/entitlements.plist" << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
          <key>get-task-allow</key>
          <true/>
          <key>com.apple.private.dtrace.allow</key>
          <true/>
          <key>com.apple.private.security.no-container</key>
          <true/>
        </dict>
        </plist>
        EOF
          
          echo "ğŸ” éªŒè¯TrollStoreç‰ˆæœ¬ç»“æ„:"
          ls -la Payload-TrollStore/
          
          echo "ğŸ“¦ æ‰“åŒ…TrollStoreç‰ˆæœ¬..."
          zip -r EasyClick-Agent-TrollStore.ipa Payload-TrollStore
          
          echo "âœ… TrollStoreç‰ˆæœ¬æ–‡ä»¶ä¿¡æ¯:"
          ls -la EasyClick-Agent-TrollStore.ipa
        else
          echo "âŒ TrollStoreç‰ˆæœ¬: æœªæ‰¾åˆ°appæ–‡ä»¶"
        fi

    - name: Create Unsigned Version (Fixed Structure)
      run: |
        cd /tmp/derivedDataPath/Build/Products/Release-iphoneos
        
        echo "ğŸ”“ åˆ›å»ºæ— ç­¾åç‰ˆæœ¬..."
        rm -rf Payload-Unsigned
        cp -r Payload Payload-Unsigned
        
        APP_DIR=$(find Payload-Unsigned -name "*.app" -type d | head -1)
        
        if [ -n "$APP_DIR" ] && [ -d "$APP_DIR" ]; then
          echo "âœ… å¤„ç†æ— ç­¾åç‰ˆæœ¬: $APP_DIR"
          
          echo "ğŸ—‘ï¸ å½»åº•ç§»é™¤æ‰€æœ‰ç­¾åæ–‡ä»¶..."
          # ç§»é™¤ä¸»appç­¾å
          rm -rf "$APP_DIR/_CodeSignature" 2>/dev/null || true
          rm -f "$APP_DIR/embedded.mobileprovision" 2>/dev/null || true
          
          # ç§»é™¤Frameworksä¸­çš„ç­¾å
          if [ -d "$APP_DIR/Frameworks" ]; then
            echo "ğŸ—‘ï¸ æ¸…ç†Frameworksç­¾å..."
            find "$APP_DIR/Frameworks" -name "_CodeSignature" -type d -exec rm -rf {} + 2>/dev/null || true
          fi
          
          # ç§»é™¤PlugInsä¸­çš„ç­¾å
          if [ -d "$APP_DIR/PlugIns" ]; then
            echo "ğŸ—‘ï¸ æ¸…ç†PlugInsç­¾å..."
            find "$APP_DIR/PlugIns" -name "_CodeSignature" -type d -exec rm -rf {} + 2>/dev/null || true
          fi
          
          # ç§»é™¤æ‰€æœ‰mobileprovisionæ–‡ä»¶
          find "$APP_DIR" -name "*.mobileprovision" -delete 2>/dev/null || true
          
          echo "ğŸ” éªŒè¯æ— ç­¾åç‰ˆæœ¬ç»“æ„:"
          ls -la Payload-Unsigned/
          
          echo "ğŸ“¦ æ‰“åŒ…æ— ç­¾åç‰ˆæœ¬..."
          zip -r EasyClick-Agent-Unsigned.ipa Payload-Unsigned
          
          echo "âœ… æ— ç­¾åç‰ˆæœ¬æ–‡ä»¶ä¿¡æ¯:"
          ls -la EasyClick-Agent-Unsigned.ipa
        else
          echo "âŒ æ— ç­¾åç‰ˆæœ¬: æœªæ‰¾åˆ°appæ–‡ä»¶"
        fi

    - name: Final Verification
      run: |
        cd /tmp/derivedDataPath/Build/Products/Release-iphoneos
        
        echo "ğŸ” æœ€ç»ˆéªŒè¯æ‰€æœ‰IPAæ–‡ä»¶:"
        for ipa in *.ipa; do
          if [ -f "$ipa" ]; then
            echo ""
            echo "ğŸ“± éªŒè¯ $ipa:"
            echo "æ–‡ä»¶å¤§å°: $(du -h "$ipa" | cut -f1)"
            echo "IPAå†…å®¹ç»“æ„:"
            unzip -l "$ipa" | grep -E "(Payload/|\.app/)" | head -10
            echo "---"
          fi
        done

    - name: Upload Standard IPA
      uses: actions/upload-artifact@v4
      with:
        name: EasyClick-Agent-Standard
        path: /tmp/derivedDataPath/Build/Products/Release-iphoneos/EasyClick-Agent-Standard.ipa
        retention-days: 30

    - name: Upload TrollStore IPA
      uses: actions/upload-artifact@v4
      with:
        name: EasyClick-Agent-TrollStore
        path: /tmp/derivedDataPath/Build/Products/Release-iphoneos/EasyClick-Agent-TrollStore.ipa
        retention-days: 30
      continue-on-error: true

    - name: Upload Unsigned IPA
      uses: actions/upload-artifact@v4
      with:
        name: EasyClick-Agent-Unsigned
        path: /tmp/derivedDataPath/Build/Products/Release-iphoneos/EasyClick-Agent-Unsigned.ipa
        retention-days: 30
      continue-on-error: true

    - name: Build Summary
      run: |
        cd /tmp/derivedDataPath/Build/Products/Release-iphoneos
        echo "ğŸ‰ æ„å»ºå®Œæˆï¼"
        echo ""
        echo "ğŸ“± ç”Ÿæˆçš„IPAæ–‡ä»¶:"
        for ipa in *.ipa; do
          if [ -f "$ipa" ]; then
            echo "âœ… $ipa - $(du -h "$ipa" | cut -f1)"
          fi
        done
        echo ""
        echo "ğŸ’¡ å¦‚æœé‡åˆ°Parse Error 301ï¼Œè¯·å°è¯•ä½¿ç”¨ä¸åŒç‰ˆæœ¬çš„IPAæ–‡ä»¶" 