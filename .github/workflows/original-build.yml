name: EasyClick Original Build Logic

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout code with LFS
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: Git LFS pull
      run: git lfs pull

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest-stable'

    - name: Verify Source Files
      run: |
        echo "ğŸ” éªŒè¯æºæ–‡ä»¶å®Œæ•´æ€§..."
        echo "iosauto.framework/iosauto æ–‡ä»¶å¤§å°:"
        ls -la iosauto.framework/iosauto
        echo ""
        echo "WebDriverAgentLib.framework/WebDriverAgentLib æ–‡ä»¶å¤§å°:"
        ls -la WebDriverAgentLib.framework/WebDriverAgentLib
        echo ""
        echo "é¡¹ç›®æ–‡ä»¶:"
        ls -la tj-easyclick-agent.xcodeproj/project.pbxproj

    - name: Build with Original Logic (Exact Copy)
      run: |
        echo "ğŸ”¨ ä½¿ç”¨åŸå§‹buildipa.shå®Œå…¨ç›¸åŒçš„é€»è¾‘..."
        
        # å®Œå…¨æŒ‰ç…§åŸå§‹è„šæœ¬çš„é€»è¾‘
        p=$(pwd)
        
        # æ¸…ç†derivedDataPath
        rm -rf /tmp/derivedDataPath/*
        
        echo "ğŸ› ï¸ å¼€å§‹xcodebuild..."
        xcodebuild build-for-testing \
          -project tj-easyclick-agent.xcodeproj \
          -scheme WebDriverAgentRunner \
          -sdk iphoneos \
          -configuration Release \
          -derivedDataPath /tmp/derivedDataPath \
          -allowProvisioningUpdates
        
        echo "ğŸ“‚ è¿›å…¥æ„å»ºç›®å½•..."
        cd /tmp/derivedDataPath
        cd Build/Products/Release-iphoneos
        
        echo "ğŸ” æ£€æŸ¥æ„å»ºè¾“å‡º:"
        ls -la
        
        echo "ğŸ—‘ï¸ ç§»é™¤IntegrationApp.app..."
        rm -r IntegrationApp.app || true
        
        echo "ğŸ“¦ åˆ›å»ºPayloadå¹¶ç§»åŠ¨appæ–‡ä»¶ï¼ˆåŸå§‹é€»è¾‘ï¼‰..."
        mkdir Payload && mv *.app Payload
        
        echo "ğŸ” éªŒè¯Payloadå†…å®¹:"
        ls -la Payload/
        
        echo "ğŸ“¦ æ‰“åŒ…IPA..."
        zip -r tj-easyclick-agent.ipa Payload
        
        echo "âœ… IPAæ–‡ä»¶ä¿¡æ¯:"
        ls -la tj-easyclick-agent.ipa
        
        echo "ğŸ” éªŒè¯IPAå†…å®¹ç»“æ„:"
        unzip -l tj-easyclick-agent.ipa | head -20
        
        # å¤åˆ¶åˆ°åŸå§‹ä½ç½®ï¼ˆæ¨¡æ‹ŸåŸå§‹è„šæœ¬ï¼‰
        cp tj-easyclick-agent.ipa $p/

    - name: Create Additional Versions
      run: |
        cd /tmp/derivedDataPath/Build/Products/Release-iphoneos
        
        echo "ğŸª åˆ›å»ºTrollStoreç‰ˆæœ¬..."
        # è§£å‹åŸå§‹IPA
        mkdir trollstore-work
        cd trollstore-work
        unzip -q ../tj-easyclick-agent.ipa
        
        # æ‰¾åˆ°appç›®å½•
        APP_DIR=$(find Payload -name "*.app" -type d | head -1)
        
        if [ -n "$APP_DIR" ]; then
          echo "ğŸ—‘ï¸ ç§»é™¤ç­¾åæ–‡ä»¶..."
          rm -rf "$APP_DIR/_CodeSignature" || true
          rm -f "$APP_DIR/embedded.mobileprovision" || true
          find "$APP_DIR" -name "*.mobileprovision" -delete || true
          
          echo "ğŸ“¦ é‡æ–°æ‰“åŒ…TrollStoreç‰ˆæœ¬..."
          zip -r ../tj-easyclick-agent-trollstore.ipa Payload
        fi
        
        cd ..
        echo "âœ… TrollStoreç‰ˆæœ¬å®Œæˆ:"
        ls -la tj-easyclick-agent-trollstore.ipa

    - name: Upload Original IPA
      uses: actions/upload-artifact@v4
      with:
        name: EasyClick-Agent-Original
        path: tj-easyclick-agent.ipa
        retention-days: 30

    - name: Upload TrollStore IPA
      uses: actions/upload-artifact@v4
      with:
        name: EasyClick-Agent-TrollStore-Fixed
        path: /tmp/derivedDataPath/Build/Products/Release-iphoneos/tj-easyclick-agent-trollstore.ipa
        retention-days: 30
      continue-on-error: true

    - name: Final Status
      run: |
        echo "ğŸ‰ æ„å»ºå®Œæˆï¼"
        echo ""
        echo "ğŸ“± ç”Ÿæˆçš„æ–‡ä»¶:"
        echo "1. tj-easyclick-agent.ipa (åŸå§‹é€»è¾‘)"
        echo "2. tj-easyclick-agent-trollstore.ipa (TrollStoreä¼˜åŒ–)"
        echo ""
        echo "ğŸ’¡ å®‰è£…å»ºè®®:"
        echo "â€¢ åŸå§‹ç‰ˆæœ¬ â†’ Sideloadly/AltStore"
        echo "â€¢ TrollStoreç‰ˆæœ¬ â†’ TrollStore"
        echo ""
        ls -la tj-easyclick-agent.ipa
        if [ -f "/tmp/derivedDataPath/Build/Products/Release-iphoneos/tj-easyclick-agent-trollstore.ipa" ]; then
          ls -la /tmp/derivedDataPath/Build/Products/Release-iphoneos/tj-easyclick-agent-trollstore.ipa
        fi 